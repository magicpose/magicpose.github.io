<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Java jstack 用法 | Pivot&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="JVM" />
  
  
  
  
  <meta name="description" content="导出JVM堆信息的方法http://fastthread.io/">
<meta name="keywords" content="JVM">
<meta property="og:type" content="article">
<meta property="og:title" content="Java jstack 用法">
<meta property="og:url" content="http://blog.magicpose.com/2017/11/16/jvm/reprint_jstack/index.html">
<meta property="og:site_name" content="Pivot&#39;s Blog">
<meta property="og:description" content="导出JVM堆信息的方法http://fastthread.io/">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://blog.magicpose.com/img/jstack-01.png">
<meta property="og:updated_time" content="2017-11-22T10:13:07.161Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java jstack 用法">
<meta name="twitter:description" content="导出JVM堆信息的方法http://fastthread.io/">
<meta name="twitter:image" content="http://blog.magicpose.com/img/jstack-01.png">
  
    <link rel="alternate" href="/atom.xml" title="Pivot&#39;s Blog" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/fashion.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


	<!-- layout.ejs是主文件, 作者：pivot,时间：2017-09-21,描述：在此处才能判断编译路径 -->
	
  	


<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="Pivot&#39;s Blog" rel="home"> Pivot&#39;s Blog </a>
            
          </h1>
          
          
            <div class="site-description">善人同处，则日闻嘉训；恶人从游，则日生邪情</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li data-desc="/" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li data-desc="archives" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">归档</a> </li>
                    
                      <li data-desc="categories" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">分类</a> </li>
                    
                      <li data-desc="tags" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">标签</a> </li>
                    
                      <li data-desc="about" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>

  
  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><!--
	作者：646759661@qq.com
	时间：2017-10-25
	描述：width: 66%; 变更为 width: 100%;
-->
<article id="post-jvm/reprint_jstack" style="width: 100%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Java jstack 用法
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/11/16/jvm/reprint_jstack/" class="article-date">
	  <time datetime="2017-11-16T03:56:13.318Z" itemprop="datePublished">十一月 16, 2017</time>
	</a>

       
      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="导出JVM堆信息的方法"><a href="#导出JVM堆信息的方法" class="headerlink" title="导出JVM堆信息的方法"></a>导出JVM堆信息的方法</h2><p><a href="http://fastthread.io/" target="_blank" rel="external">http://fastthread.io/</a><br><a id="more"></a> </p>
<h3 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h3><blockquote>
<p>‘jstack’ is an effective command line tool to capture thread dumps. jstack tool is shipped in JDK_HOMEbin folder. Here is the command that you need to issue to capture thread dump:</p>
<p><code>jstack -l  &lt;pid&gt; &gt; &lt;file-path&gt;</code>  </p>
<p>where<br>pid: is the Process Id of the application, whose thread dump should be captured</p>
<p>file-path: is the file path where thread dump will be written in to.<br>Example:</p>
<p><code>jstack -l 37320 &gt; /opt/tmp/threadDump.txt</code>   </p>
<p>As per the example thread dump of the process would be generated in /opt/tmp/threadDump.txt file.</p>
<p>Jstack tool is included in JDK since Java 5. If you are running in older version of java, consider using other options</p>
</blockquote>
<h3 id="jcmd"><a href="#jcmd" class="headerlink" title="jcmd"></a>jcmd</h3><blockquote>
<p>The jcmd tool was introduced with Oracle’s Java 7. It’s useful in troubleshooting issues with JVM applications. It has various capabilities such as identifying java process Ids, acquiring heap dumps, acquiring thread dumps, acquiring garbage collection statistics, ….</p>
<p>Using the below JCMD command you can generate thread dump:</p>
<p><code>jcmd &lt;pid&gt; Thread.print &gt; &lt;file-path&gt;</code><br>where<br>pid: is the Process Id of the application, whose thread dump should be captured<br>file-path: is the file path where thread dump will be written in to.</p>
<p>Example:<br><code>jcmd 37320 Thread.print &gt; /opt/tmp/threadDump.txt</code><br>As per the example thread dump of the process would be generated in /opt/tmp/threadDump.txt file.</p>
</blockquote>
<h2 id="实际使用分析"><a href="#实际使用分析" class="headerlink" title="实际使用分析"></a>实际使用分析</h2><p><a href="https://www.pocketdigi.com/20170523/1574.html" target="_blank" rel="external">应用开发笔记</a></p>
<p>jstack是jdk中自带的用于查看进程内线程栈的工具。当程序出现死锁时，我们可以通过jstack打印线程栈找到问题。</p>
<h3 id="找出代码中的死锁"><a href="#找出代码中的死锁" class="headerlink" title="找出代码中的死锁"></a>找出代码中的死锁</h3><p>学习从一段简单的代码开始:<br><!-- more --><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        test1();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Object lock1 = <span class="keyword">new</span> Object();</div><div class="line">        <span class="keyword">final</span> Object lock2 = <span class="keyword">new</span> Object();</div><div class="line">        Thread thread=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">synchronized</span> (lock1) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++) &#123;</div><div class="line">                            Thread.sleep(<span class="number">1000</span>);</div><div class="line">                            System.out.println(Thread.currentThread().getName()+<span class="string">" "</span>+i);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">synchronized</span> (lock2) &#123;</div><div class="line">                            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">20</span>;i&lt;<span class="number">40</span>;i++) &#123;</div><div class="line">                                Thread.sleep(<span class="number">1000</span>);</div><div class="line">                                System.out.println(Thread.currentThread().getName()+<span class="string">" "</span>+i);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        thread.start();</div><div class="line">        <span class="keyword">synchronized</span> (lock2) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++) &#123;</div><div class="line">                    Thread.sleep(<span class="number">1000</span>);</div><div class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">" "</span>+i);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">synchronized</span> (lock1) &#123;</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">20</span>;i&lt;<span class="number">40</span>;i++) &#123;</div><div class="line">                        Thread.sleep(<span class="number">1000</span>);</div><div class="line">                        System.out.println(Thread.currentThread().getName()+<span class="string">" "</span>+i);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>肉眼都能看出来的死锁，程序运行20s后进入死锁状态。<br>首先我们先找出这个程序的进程id,建议用jps,而不是ps,原因是jps只会显示当前用户下面的java进程，等于自动帮我们过滤了。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">jps -l</div><div class="line"></div><div class="line">$ jps</div><div class="line">8896 Bootstrap</div><div class="line">3941 Bootstrap</div><div class="line">11718 Jps</div><div class="line">9711 Bootstrap</div></pre></td></tr></table></figure></p>
<p>jstack 显示堆栈信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">$ jstack <span class="number">9711</span></div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">05</span>-<span class="number">23</span> <span class="number">13</span>:<span class="number">57</span>:<span class="number">22</span></div><div class="line"><span class="function">Full thread dump Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server <span class="title">VM</span> <span class="params">(<span class="number">25.45</span>-b02 mixed mode)</span>:</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">"Attach Listener" #12 daemon prio</span>=<span class="number">9</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f780c800</span> nid=<span class="number">0x4507</span> waiting on condition [<span class="number">0x0000000000000000</span>]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line"></div><div class="line">"Thread-0" #11 prio=5 os_prio=31 tid=0x00007ff0f80c0000 nid=0x5a03 waiting for monitor entry [0x0000700002310000]</div><div class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</div><div class="line">    at Main$<span class="number">1</span>.run(Main.java:<span class="number">33</span>)</div><div class="line">    - waiting to lock &lt;<span class="number">0x000000076adb1a98</span>&gt; (a java.lang.Object)</div><div class="line">    - locked &lt;<span class="number">0x000000076adb1a88</span>&gt; (a java.lang.Object)</div><div class="line">    at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</div><div class="line"></div><div class="line">"Service Thread" #10 daemon prio=9 os_prio=31 tid=0x00007ff0f980b800 nid=0x5603 runnable [0x0000000000000000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line"></div><div class="line">"C1 CompilerThread3" #9 daemon prio=9 os_prio=31 tid=0x00007ff0f6803000 nid=0x5403 waiting on condition [0x0000000000000000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line"></div><div class="line">"C2 CompilerThread2" #8 daemon prio=9 os_prio=31 tid=0x00007ff0f6802800 nid=0x5203 waiting on condition [0x0000000000000000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line"></div><div class="line">"C2 CompilerThread1" #7 daemon prio=9 os_prio=31 tid=0x00007ff0f6801800 nid=0x5003 waiting on condition [0x0000000000000000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line"></div><div class="line">"C2 CompilerThread0" #6 daemon prio=9 os_prio=31 tid=0x00007ff0f90de800 nid=0x4e03 waiting on condition [0x0000000000000000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line"></div><div class="line">"Monitor Ctrl-Break" #5 daemon prio=5 os_prio=31 tid=0x00007ff0f90dc800 nid=0x4c03 runnable [0x0000700001bfb000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line">    at java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">    at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</div><div class="line">    at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">170</span>)</div><div class="line">    at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</div><div class="line">    at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:<span class="number">284</span>)</div><div class="line">    at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:<span class="number">326</span>)</div><div class="line">    at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:<span class="number">178</span>)</div><div class="line">    - locked &lt;<span class="number">0x000000076af12b68</span>&gt; (a java.io.InputStreamReader)</div><div class="line">    at java.io.InputStreamReader.read(InputStreamReader.java:<span class="number">184</span>)</div><div class="line">    at java.io.BufferedReader.fill(BufferedReader.java:<span class="number">161</span>)</div><div class="line">    at java.io.BufferedReader.readLine(BufferedReader.java:<span class="number">324</span>)</div><div class="line">    - locked &lt;<span class="number">0x000000076af12b68</span>&gt; (a java.io.InputStreamReader)</div><div class="line">    at java.io.BufferedReader.readLine(BufferedReader.java:<span class="number">389</span>)</div><div class="line">    at com.intellij.rt.execution.application.AppMainV2$<span class="number">1</span>.run(AppMainV2.java:<span class="number">64</span>)</div><div class="line"></div><div class="line">"Signal Dispatcher" #4 daemon prio=9 os_prio=31 tid=0x00007ff0f8039800 nid=0x4a03 runnable [0x0000000000000000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line"></div><div class="line">"Finalizer" #3 daemon prio=8 os_prio=31 tid=0x00007ff0f9803000 nid=0x3903 in Object.wait() [0x0000700001972000]</div><div class="line">   java.lang.Thread.State: WAITING (on object monitor)</div><div class="line">    at java.lang.Object.wait(Native Method)</div><div class="line">    - waiting on &lt;<span class="number">0x000000076ab06f58</span>&gt; (a java.lang.ref.ReferenceQueue$Lock)</div><div class="line">    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:<span class="number">143</span>)</div><div class="line">    - locked &lt;<span class="number">0x000000076ab06f58</span>&gt; (a java.lang.ref.ReferenceQueue$Lock)</div><div class="line">    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:<span class="number">164</span>)</div><div class="line">    at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:<span class="number">209</span>)</div><div class="line"></div><div class="line">"Reference Handler" #2 daemon prio=10 os_prio=31 tid=0x00007ff0f9802000 nid=0x3703 in Object.wait() [0x000070000186f000]</div><div class="line">   java.lang.Thread.State: WAITING (on object monitor)</div><div class="line">    at java.lang.Object.wait(Native Method)</div><div class="line">    - waiting on &lt;<span class="number">0x000000076ab06998</span>&gt; (a java.lang.ref.Reference$Lock)</div><div class="line">    at java.lang.Object.wait(Object.java:<span class="number">502</span>)</div><div class="line">    at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:<span class="number">157</span>)</div><div class="line">    - locked &lt;<span class="number">0x000000076ab06998</span>&gt; (a java.lang.ref.Reference$Lock)</div><div class="line"></div><div class="line">"main" #1 prio=5 os_prio=31 tid=0x00007ff0f8002000 nid=0x1c03 waiting for monitor entry [0x0000700000e51000]</div><div class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</div><div class="line">    at Main.test1(Main.java:<span class="number">52</span>)</div><div class="line">    - waiting to lock &lt;<span class="number">0x000000076adb1a88</span>&gt; (a java.lang.Object)</div><div class="line">    - locked &lt;<span class="number">0x000000076adb1a98</span>&gt; (a java.lang.Object)</div><div class="line">    at Main.main(Main.java:<span class="number">18</span>)</div><div class="line"></div><div class="line"><span class="string">"VM Thread"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f801f800</span> nid=<span class="number">0x3503</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#0 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f9003800</span> nid=<span class="number">0x2503</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#1 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f9004000</span> nid=<span class="number">0x2703</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#2 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f7801000</span> nid=<span class="number">0x2903</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#3 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f600e800</span> nid=<span class="number">0x2b03</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#4 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f600f000</span> nid=<span class="number">0x2d03</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#5 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f6010000</span> nid=<span class="number">0x2f03</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#6 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f6010800</span> nid=<span class="number">0x3103</span> runnable</div><div class="line"></div><div class="line"><span class="string">"GC task thread#7 (ParallelGC)"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f6011000</span> nid=<span class="number">0x3303</span> runnable</div><div class="line"></div><div class="line"><span class="string">"VM Periodic Task Thread"</span> os_prio=<span class="number">31</span> tid=<span class="number">0x00007ff0f980c000</span> nid=<span class="number">0x5803</span> waiting on condition</div><div class="line"></div><div class="line">JNI global references: <span class="number">26</span></div><div class="line"></div><div class="line"></div><div class="line">Found one Java-level deadlock:</div><div class="line">=============================</div><div class="line"><span class="string">"Thread-0"</span>:</div><div class="line">  waiting to lock monitor <span class="number">0x00007ff0f8024f38</span> (object <span class="number">0x000000076adb1a98</span>, a java.lang.Object),</div><div class="line">  which is held by <span class="string">"main"</span></div><div class="line"><span class="string">"main"</span>:</div><div class="line">  waiting to lock monitor <span class="number">0x00007ff0f8023bf8</span> (object <span class="number">0x000000076adb1a88</span>, a java.lang.Object),</div><div class="line">  which is held by <span class="string">"Thread-0"</span></div><div class="line"></div><div class="line">Java stack information <span class="keyword">for</span> the threads listed above:</div><div class="line">===================================================</div><div class="line"><span class="string">"Thread-0"</span>:</div><div class="line">    at Main$<span class="number">1</span>.run(Main.java:<span class="number">33</span>)</div><div class="line">    - waiting to lock &lt;<span class="number">0x000000076adb1a98</span>&gt; (a java.lang.Object)</div><div class="line">    - locked &lt;<span class="number">0x000000076adb1a88</span>&gt; (a java.lang.Object)</div><div class="line">    at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</div><div class="line"><span class="string">"main"</span>:</div><div class="line">    at Main.test1(Main.java:<span class="number">52</span>)</div><div class="line">    - waiting to lock &lt;<span class="number">0x000000076adb1a88</span>&gt; (a java.lang.Object)</div><div class="line">    - locked &lt;<span class="number">0x000000076adb1a98</span>&gt; (a java.lang.Object)</div><div class="line">    at Main.main(Main.java:<span class="number">18</span>)</div><div class="line"></div><div class="line">Found <span class="number">1</span> deadlock.</div></pre></td></tr></table></figure></p>
<p>jstack直接帮我们找出来了deadlock。真实场景下，如果代码比较复杂，可能需要我们自己分析找出死锁。<br>如果我们自己分析，该怎么找出死锁呢？重点分析java.lang.Thread.State: BLOCKED的进程，找到<br>waiting to lock，看看这个锁的持有者，是不是也被锁着，沿着这个链路找下去，是不是死锁就能找出来 了。比如上面的例子中,main线程持有0x000000076adb1a98锁，等待0x000000076adb1a88锁释放，而Thread-0持有0x000000076adb1a88锁，等待0x000000076adb1a98锁释放，两个线程互相等待，而进入死锁状态。</p>
<h3 id="找出CPU消耗多的代码"><a href="#找出CPU消耗多的代码" class="headerlink" title="找出CPU消耗多的代码"></a>找出CPU消耗多的代码</h3><p>如果程序cpu占用很高，我们需要找到问题优化，可以配合top命令，找出最耗cpu的进程，从而找到相应代码解决问题。</p>
<ul>
<li><p>先用jps找出程序pid，这里是23034</p>
</li>
<li><p>用top命令找出该进程最耗cpu的线程。下面的top是linux中的，mac里的不一样。</p>
<blockquote>
<p><code>top -Hp 9711</code><br><img src="http://blog.magicpose.com/img/jstack-01.png" alt="top -Hp &lt;pid&gt;"></p>
</blockquote>
</li>
<li><p>查看占用CPU较高的PID,并将其转化为16进制<br>因为top里的pid是10进制，而jstack里是16进制，叫nid。<br>可以用printf命令转换</p>
<blockquote>
<p><code>printf &quot;%x\n&quot; &lt;pid&gt;</code> 得到16进制PID</p>
</blockquote>
</li>
<li><p>jstack出场</p>
<blockquote>
<p><code>jstack 23034 | grep 16进制PID</code> 查看并分析结果找出问题</p>
</blockquote>
</li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JVM/">JVM</a></li></ul>

      
        
	<section id="comments" class="comment">
		<!-- UY BEGIN -->
		<div id="uyan_frame"></div>
		<script type="text/javascript">
			(function(){
			  var dsq = document.createElement('script');
			  dsq.type = 'text/javascript';
			  dsq.async = true;
			  dsq.src = "http://v2.uyan.cc/code/uyan.js?uid=2145478";
			  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			}());
		</script>
		<!-- UY END -->
	</section>


      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/11/22/h2/install h2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          H2 数据库安装
        
      </div>
    </a>
  
  
    <a href="/2017/11/13/English/directory/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">专业名词解释 1</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#导出JVM堆信息的方法"><span class="nav-number">1.</span> <span class="nav-text">导出JVM堆信息的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jstack"><span class="nav-number">1.1.</span> <span class="nav-text">jstack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jcmd"><span class="nav-number">1.2.</span> <span class="nav-text">jcmd</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实际使用分析"><span class="nav-number">2.</span> <span class="nav-text">实际使用分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#找出代码中的死锁"><span class="nav-number">2.1.</span> <span class="nav-text">找出代码中的死锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#找出CPU消耗多的代码"><span class="nav-number">2.2.</span> <span class="nav-text">找出CPU消耗多的代码</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2017 Pivot&#39;s Blog All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
